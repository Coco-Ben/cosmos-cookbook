{% extends "base.html" %}

{% block extrahead %}
{{ super() }}
{% if not config.extra.local_dev %}
<!-- OneTrust Cookies Consent Notice start for nvidia-cosmos.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="019c0510-0233-7bb8-be91-9083a1e91694{% if config.extra.cookie_test_mode %}-test{% endif %}" ></script>
<script type="text/javascript">
function OptanonWrapper() {
        var event = new Event('bannerLoaded');
        window.dispatchEvent(event);
    }
</script>
<script type="text/javascript" src="https://images.nvidia.com/aem-dam/Solutions/ot-js/ot-custom.js"></script>

<!-- OneTrust Cookies Consent Notice end for nvidia-cosmos.github.io -->

<script src="//assets.adobedtm.com/5d4962a43b79/814eb6e9b4e1/launch-4bc07f1e0b0b.min.js"></script>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">_satellite.pageBottom();</script>

<!-- Custom Navigation Filter: sidebar list is generated from nav_pages.json (like index.md filtered list) -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const navList = document.querySelector('.md-nav--primary > .md-nav__list');
    if (!navList) return;

    // Hide MkDocs nav items that belong to Getting Started, Recipes, or Concepts (we replace them with a data-driven list)
    const navItems = Array.from(navList.children).filter(item => item.classList.contains('md-nav__item'));
    navItems.forEach(item => {
      const directLink = item.querySelector(':scope > a.md-nav__link[href]');
      if (directLink) {
        const href = directLink.getAttribute('href');
        const linkText = (directLink.textContent || '').trim().toLowerCase();
        if (href === 'recipes/' || href === 'recipes/index.html' || (href && href.match(/^recipes\/?$/) && linkText.includes('recipe'))) {
          item.style.display = 'none';
        } else if (href === 'core_concepts/' || href === 'core_concepts/index.html' || (href && href.match(/^core_concepts\/?$/) && linkText.includes('concept'))) {
          item.style.display = 'none';
        } else if (href && (href.startsWith('recipes/') || href.includes('/recipes/'))) {
          item.style.display = 'none';
        } else if (href && (href.startsWith('core_concepts/') || href.includes('/core_concepts/'))) {
          item.style.display = 'none';
        } else if (href && (href.startsWith('getting_started/') || href.includes('/getting_started/'))) {
          item.style.display = 'none';
        }
      }
      if (item.classList.contains('md-nav__item--nested')) {
        const nestedLinks = item.querySelectorAll('nav a[href]');
        const allHrefs = Array.from(nestedLinks).map(a => a.getAttribute('href'));
        const allGettingStarted = allHrefs.length > 0 && allHrefs.every(h => h && (h.startsWith('getting_started/') || h.includes('/getting_started/')));
        const allRecipes = allHrefs.length > 0 && allHrefs.every(h => h && (h.startsWith('recipes/') || h.includes('/recipes/')));
        const allConcepts = allHrefs.length > 0 && allHrefs.every(h => h && (h.startsWith('core_concepts/') || h.includes('/core_concepts/')));
        if (allGettingStarted || allRecipes || allConcepts) {
          item.style.display = 'none';
        }
      }
    });

    // Build filter section with Content Type buttons and container for dynamic list
    const filterSection = document.createElement('li');
    filterSection.className = 'md-nav__item md-nav__item--section';
    filterSection.style.cssText = 'border-top: 1px solid var(--md-default-fg-color--lightest); margin-top: 1rem; padding-top: 0.5rem;';
    filterSection.innerHTML = `
      <label class="md-nav__link" style="font-weight: 600; cursor: default; pointer-events: none;">
        <span class="md-ellipsis">Content Type</span>
      </label>
      <nav class="md-nav" aria-label="Filter">
        <ul class="md-nav__list">
          <li class="md-nav__item">
            <a href="javascript:void(0)" class="md-nav__link content-filter active" data-filter="getting_started">
              <span class="md-ellipsis">✓ Get Started</span>
            </a>
          </li>
          <li class="md-nav__item">
            <a href="javascript:void(0)" class="md-nav__link content-filter" data-filter="recipes">
              <span class="md-ellipsis">Recipes</span>
            </a>
          </li>
          <li class="md-nav__item">
            <a href="javascript:void(0)" class="md-nav__link content-filter" data-filter="core_concepts">
              <span class="md-ellipsis">Concepts</span>
            </a>
          </li>
        </ul>
        <ul id="dynamic-nav-list" class="md-nav__list"></ul>
      </nav>
    `;

    // Insert filter section before Glossary
    const navItemsArray = Array.from(navList.children);
    let insertIndex = navItemsArray.length;
    for (let i = 0; i < navItemsArray.length; i++) {
      if (navItemsArray[i].querySelector('a[href*="glossary"]')) {
        insertIndex = i;
        break;
      }
    }
    if (insertIndex < navItemsArray.length) {
      navList.insertBefore(filterSection, navItemsArray[insertIndex]);
    } else {
      navList.appendChild(filterSection);
    }

    const glossaryItem = Array.from(navList.children).find(item => item.querySelector('a[href*="glossary"]'));
    if (glossaryItem) {
      glossaryItem.style.borderTop = '1px solid var(--md-default-fg-color--lightest)';
      glossaryItem.style.marginTop = '1rem';
      glossaryItem.style.paddingTop = '0.5rem';
    }

    let navData = null;
    // Path from current page to site root (where index.html and nav_pages.json live)
    function getBaseToRoot() {
      const pathname = (window.location.pathname || '').replace(/^\//, '').replace(/\/$/, '');
      const segments = pathname ? pathname.split('/') : [];
      // Go up (n-1) levels from current file to reach its directory, then (n-1)-1 more to reach site root.
      // So from file at depth n we need max(0, n-2) "../" (0 when at root or one level deep).
      const depth = segments.length;
      const up = depth <= 2 ? 0 : depth - 2;
      return up ? '../'.repeat(up) : '';
    }
    function getNavJsonUrl() {
      return getBaseToRoot() + 'nav_pages.json';
    }

    function renderNavList(sectionKey) {
      const container = document.getElementById('dynamic-nav-list');
      if (!container || !navData || !navData[sectionKey]) return;
      const pages = navData[sectionKey];
      const baseToRoot = getBaseToRoot();
      const currentPath = (window.location.pathname || '').replace(/\/index\.html$/, '').replace(/\/$/, '') || '/';
      container.innerHTML = '';
      pages.forEach(function(page) {
        const li = document.createElement('li');
        li.className = 'md-nav__item';
        const a = document.createElement('a');
        a.className = 'md-nav__link';
        a.href = baseToRoot + page.url;
        const span = document.createElement('span');
        span.className = 'md-ellipsis';
        span.textContent = page.title;
        a.appendChild(span);
        const pagePath = new URL(baseToRoot + page.url, window.location.href).pathname.replace(/\/index\.html$/, '').replace(/\/$/, '') || '/';
        if (currentPath === pagePath || (pagePath && currentPath.endsWith(pagePath))) {
          a.classList.add('md-nav__link--active');
        }
        li.appendChild(a);
        container.appendChild(li);
      });
    }

    function setFilterActive(filterType) {
      document.querySelectorAll('.content-filter').forEach(el => {
        el.classList.remove('active');
        const span = el.querySelector('.md-ellipsis');
        if (span) span.textContent = span.textContent.replace('✓ ', '');
      });
      const active = document.querySelector('.content-filter[data-filter="' + filterType + '"]');
      if (active) {
        active.classList.add('active');
        const span = active.querySelector('.md-ellipsis');
        if (span && !span.textContent.startsWith('✓ ')) span.textContent = '✓ ' + span.textContent;
      }
      localStorage.setItem('navFilter', filterType);
    }

    function applyFilter(filterType) {
      setFilterActive(filterType);
      renderNavList(filterType);
    }

    function getSectionFromPath() {
      const path = window.location.pathname || '';
      if (path.includes('getting_started') || path.includes('get_started')) return 'getting_started';
      if (path.includes('/recipes/') || path.includes('/recipes')) return 'recipes';
      if (path.includes('core_concepts')) return 'core_concepts';
      return null;
    }

    document.querySelectorAll('.content-filter').forEach(function(filter) {
      filter.addEventListener('click', function(e) {
        e.preventDefault();
        applyFilter(this.getAttribute('data-filter'));
      });
    });

    fetch(getNavJsonUrl())
      .then(function(r) { return r.ok ? r.json() : null; })
      .then(function(data) {
        navData = data || { getting_started: [], recipes: [], core_concepts: [] };
        const initialFilter = getSectionFromPath() || localStorage.getItem('navFilter') || 'getting_started';
        applyFilter(initialFilter);
      })
      .catch(function() {
        navData = { getting_started: [], recipes: [], core_concepts: [] };
        applyFilter(localStorage.getItem('navFilter') || 'getting_started');
      });
  });
</script>

<style>
  .content-filter {
    cursor: pointer !important;
    transition: background-color 0.2s ease, color 0.2s ease;
    user-select: none;
  }
  
  .content-filter:hover {
    background-color: var(--md-accent-fg-color--transparent) !important;
  }
  
  .content-filter.active {
    background-color: var(--md-accent-fg-color--transparent) !important;
    color: var(--md-accent-fg-color) !important;
    font-weight: 700;
  }
</style>
{% endblock %}
